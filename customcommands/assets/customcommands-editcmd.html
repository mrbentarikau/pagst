{{define "cp_custom_commands_edit_cmd"}}
{{template "cp_head" .}}
<header class="page-header">
    <h2>Custom commands</h2>
</header>

{{template "cp_alerts" .}}

<style>
    .cc-editor {
        font-family: Consolas, monospace;
    }
</style>

<!-- Nav -->
<div class="row">
    <div class="col">
        <!-- Nav tabs -->
        <div class="tabs">
            <ul class="nav nav-tabs">
                <li class="nav-item {{if and (not .CurrentCommandGroup)}}active{{end}}">
                    <a data-partial-load="true" class="nav-link show {{if not .CurrentCommandGroup}}active{{end}}"
                        href="/manage/{{.ActiveGuild.ID}}/customcommands/">Ungrouped</a>
                </li>
                {{$dot := .}}
                {{range .CommandGroups}}
                <li
                    class="nav-item {{if $dot.CurrentCommandGroup}}{{if eq $dot.CurrentCommandGroup.ID .ID}}active{{end}}{{end}}">
                    <a data-partial-load="true"
                        class="nav-link show {{if $dot.CurrentCommandGroup}}{{if eq $dot.CurrentCommandGroup.ID .ID}}active{{end}}{{end}}"
                        href="/manage/{{$dot.ActiveGuild.ID}}/customcommands/groups/{{.ID}}">{{.Name}}</a>
                </li>
                {{end}}
                <li class="nav-item">
                    <form class="form-horizontal" method="post"
                        action="/manage/{{.ActiveGuild.ID}}/customcommands/creategroup" data-async-form>
                        <input type="text" class="hidden" name="Name" value="Unnamed group">
                        <input clasS="nav-link show" type="submit" value="+"></input>
                    </form>
                </li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div class="tab-pane active">

                    <ul id="cc-feedback-top">
                        <li class="text-danger" hidden id="trigger-warning"></li>
                    </ul>


                    {{$guild := .ActiveGuild.ID}}
                    {{$g := .ActiveGuild}}
                    {{$dot := .}}
                    <form class="form-horizontal" method="post"
                        action="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/update" data-async-form id="pagstForm">
                        <button type="submit" class="hidden"
                            formaction="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/update"
                            data-async-form-alertsonly></button>

                        <h2 class="card-title">
                            #{{.CC.LocalID}} -
                            {{index .CCTriggerTypes .CC.TriggerType}}{{if and (ne .CC.TriggerType 5) (ne .CC.TriggerType 6) (eq .CC.TriggerType 0)}}:
                            <span class="cc-text-trigger-span">{{.CC.TextTrigger}}</span>
                            {{else if eq .CC.TriggerType 1 2 3 4}}:
                            <span class="cc-text-trigger-span">{{or .CC.RegexTrigger .CC.TextTrigger}}</span>
                            {{else if and (ne .CC.TriggerType 6) (ne .CC.TriggerType 10)}}:
                            Every
                            {{call .GetCCInterval .CC}}
                            {{if eq (call .GetCCIntervalType .CC) 1}}hour(s){{else}}minute(s){{end}}{{end}}
                            <a href="." title="Reload page"><i style="font-size: 0.5em" class="fas fa-sync fa-xs"></i></a>
                        </h2>
                        <input type="text" class="hidden form-control" name="id" value="{{.CC.LocalID}}">
                        Last run: {{if .CC.LastRun.Valid}}<span id="PAGST-CC-Last-Run" title="{{.CC.LastRun.Time.UTC.Format `2006-01-02 15:04:05 MST`}}"><script>
                            var runDate = new Date({{.CC.LastRun.Time.UTC.Unix}} * 1000);
                                document.getElementById("PAGST-CC-Last-Run").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(runDate);
                        </script></span>{{else}}N/A{{end}}<br/>
                        Last saved: {{if ne .CC.DateUpdated.Time.Year 1}}<span id="PAGST-CC-Last-Saved" title="{{.CC.DateUpdated.Time.UTC.Format `2006-01-02 15:04:05 MST`}}">
                        <script>
                            var saveDate = new Date({{.CC.DateUpdated.Time.UTC.Unix}} * 1000);
                                document.getElementById("PAGST-CC-Last-Saved").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(saveDate);
                        </script></span>{{else}}N/A{{end}}<br/>
                        {{if (eq .CC.TriggerType 5)}}Next run: <span id="PAGST-CC-Next-Run" title="{{.CC.NextRun.Time.UTC.Format `2006-01-02 15:04:05 MST`}}">
                                        <script>
                                            var date = new Date({{.CC.NextRun.Time.UTC.Unix}} * 1000);
                                                document.getElementById("PAGST-CC-Next-Run").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(date);
                                        </script>
                                    </span><br/>{{end}}
                        Run count: {{humanizeThousands .CC.RunCount}}<br/><br/>
                        <div class="row">
                            <!-- Trigger -->
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Trigger type</label>
                                            <select class="form-control" id="trigger-type-dropdown" name="type"
                                                onchange="triggerTypeChanged(this)">

                                                <option value="none" {{if eq .CC.TriggerType 10}}selected{{end}}>None
                                                </option>
                                                <option value="cmd" {{if eq .CC.TriggerType 0}} selected{{end}}>Command
                                                    (mention/cmd
                                                    prefix)</option>
                                                <option value="prefix" {{if eq .CC.TriggerType 1}} selected{{end}}>
                                                    Starts with</option>
                                                <option value="contains" {{if eq .CC.TriggerType 2}} selected{{end}}>
                                                    Contains</option>
                                                <option value="regex" {{if eq .CC.TriggerType 3}} selected{{end}}>Regex
                                                </option>
                                                <option value="exact" {{if eq .CC.TriggerType 4}} selected{{end}}>Exact
                                                    match</option>
                                                <option value="reaction" {{if eq .CC.TriggerType 6}} selected{{end}}>
                                                    Reaction</option>
                                                <option value="interval_hours"
                                                    {{if eq (call .GetCCIntervalType .CC) 1}}selected{{end}}>
                                                    Hourly interval
                                                </option>
                                                <option value="interval_minutes"
                                                    {{if eq (call .GetCCIntervalType .CC) 0}}selected{{end}}>
                                                    Minute interval
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col" id="trigger-help">
                                        <p id="trigger-desc-none" class="text-danger">
                                            No trigger: can only be triggered manually by other custom
                                            commands
                                        </p>
                                        <p id="trigger-desc-cmd">
                                            CC trigger works the same way as normal commands by using the
                                            command prefix or bot mention followed by the trigger.
                                        </p>
                                        <p id="trigger-desc-prefix">
                                            Any message that starts with the trigger will run the command.
                                        </p>
                                        <p id="trigger-desc-contains">
                                            Any message that contains the trigger will run the command.
                                        </p>
                                        <p id="trigger-desc-regex">
                                            Any message that matches the provided regex will trigger the command.
                                        </p>
                                        <p id="trigger-desc-exact">
                                            Any message that is equal to the trigger will run the command.
                                        </p>
                                        <p id="trigger-desc-reaction">
                                            The command will trigger on the specified reaction events.
                                        </p>
                                        <p id="trigger-desc-interval_hours">
                                            The command will run at a hourly interval, for example every 5 hours.
                                        </p>
                                        <p id="trigger-desc-interval_minutes">
                                            The command will run at a minute interval, for example every 10 minutes.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div id="cc-text-trigger-details" class="hidden col-sm-8">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label>Trigger (<span class="trigger-length-counter">{{toRune .CC.TextTrigger|len}}</span>/256)</label>
                                             <div class="input-group mb-2">
                                                <div class="input-group-prepend" id="command-trigger-prepended-prefix">
                                                    <div class="input-group-text">{{.CommandPrefix}}</div>
                                                </div>
                                                <input type="text" class="pagst-trigger form-control" name="trigger" placeholder="void"
                                                value="{{.CC.TextTrigger}}" oninput="onTriggerChanged(this)">
                                            </div>
                                            {{checkbox "case_sensitive" "case_sensitive" "Case Sensitive?" .CC.TextTriggerCaseSensitive}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="cc-regex-trigger-details" class="hidden col-sm-8">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label>Trigger (<span class="trigger-length-counter">{{or (toRune .CC.RegexTrigger|len) (toRune .CC.TextTrigger|len)}}</span>/256)</label>
                                            <input type="text" class="pagst-trigger form-control" name="regex_trigger" placeholder="void"
                                                value="{{or .CC.RegexTrigger .CC.TextTrigger}}" oninput="onTriggerChanged(this)">

                                            {{checkbox "regex_case_sensitive" "regex_case_sensitive" "Case Sensitive?" .CC.RegexTriggerCaseSensitive}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="cc-reaction-trigger-details" class="hidden col-sm-8">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reaction_trigger_mode"
                                                id="reaction-mode-both-{{.CC.LocalID}}" value="0"
                                                {{if eq .CC.ReactionTriggerMode 0}}checked{{end}}>
                                            <label class="form-check-label" for="reaction-mode-both-{{.CC.LocalID}}">
                                                Added + Removed reactions
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reaction_trigger_mode"
                                                id="reaction-mode-added-{{.CC.LocalID}}" value="1"
                                                {{if eq .CC.ReactionTriggerMode 1}}checked{{end}}>
                                            <label class="form-check-label" for="reaction-mode-added-{{.CC.LocalID}}">
                                                Added reactions only
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reaction_trigger_mode"
                                                id="reaction-mode-removed-{{.CC.LocalID}}" value="2"
                                                {{if eq .CC.ReactionTriggerMode 2}}checked{{end}}>
                                            <label class="form-check-label" for="reaction-mode-removed-{{.CC.LocalID}}">
                                                Removed reactions only
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="cc-time-trigger-details" class="hidden col-sm-8">
                                <div class="row">
                                    <div class="col-sm-2">
                                        <div class="form-group">
                                            <label>Start time (UTC)</label>&nbsp;<sup><i class="fa-solid fa-info" title="Interval trigger first start. Will be next day, if set before current UTC-time."></i></sup>
                                            <input type="time" min="00:00" max="23:59" class="form-control" name="time_trigger_starts_at" value="{{currentTime.Format `15:04`}}">
                                        </div>
                                    </div>
                                    <div class="col-sm-2">
                                        <div class="form-group">
                                            <label>Interval</label>
                                            <input type="number" min="0" class="form-control" name="time_trigger_interval"
                                                placeholder="" value="{{call $dot.GetCCInterval .CC}}">
                                        </div>
                                    </div>
                                   <div class="col-sm-2">
                                        <div class="form-group">
                                            <label for="trigger">Excluding hours (UTC)</label><br>
                                            <select name="time_trigger_excluding_hours" class="multiselect form-control"
                                                multiple="multiple" data-plugin-multiselect>
                                                {{$selectedExclHours := .CC.TimeTriggerExcludingHours}}
                                                {{range seq 0 24}}<option value="{{.}}"
                                                    {{if in $selectedExclHours .}}selected{{end}}>{{.}}</option>
                                                {{end}}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="trigger">Excluding weekdays (UTC)</label><br>
                                            <select name="time_trigger_excluding_days" class="multiselect form-control"
                                                multiple="multiple" data-plugin-multiselect>
                                                <option value="1"
                                                    {{if in .CC.TimeTriggerExcludingDays 1}}selected{{end}}>
                                                    Monday</option>
                                                <option value="2"
                                                    {{if in .CC.TimeTriggerExcludingDays 2}}selected{{end}}>
                                                    Tuesday</option>
                                                <option value="3"
                                                    {{if in .CC.TimeTriggerExcludingDays 3}}selected{{end}}>
                                                    Wednesday</option>
                                                <option value="4"
                                                    {{if in .CC.TimeTriggerExcludingDays 4}}selected{{end}}>
                                                    Thursday</option>
                                                <option value="5"
                                                    {{if in .CC.TimeTriggerExcludingDays 5}}selected{{end}}>
                                                    Friday</option>
                                                <option value="6"
                                                    {{if in .CC.TimeTriggerExcludingDays 6}}selected{{end}}>
                                                    Saturday</option>
                                                <option value="0"
                                                    {{if in .CC.TimeTriggerExcludingDays 0}}selected{{end}}>
                                                    Sunday</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-8">
                                        <div class="form-group">
                                            <label>Channel</label>
                                            <select id="time-trigger-channel" name="context_channel" class="form-control">
                                                {{textChannelOptions $g.Channels .CC.ContextChannel true "None"}}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <div style="margin: 0 3px 7px 0px">Editor theme:
                                        <select onchange="selectTheme()" id=themeSelect style="background-color: #282828;color:#a1a1a1;border-color:#a1a1a1;">
                                            <option selected>no CodeMirror</option>
                                            {{range cslice "ayu-dark" "bespin" "cobalt" "darcula" "gruvbox-dark" "mbo" "monokai" "nord" "panda-syntax" "vibrant-ink" "yonce"}}
                                                <option>{{.}}</option>
                                            {{end}}
                                        </select>
                                        <span style="margin-left:5px">Auto-close brackets:<i style="position: relative; top: -0.5em; font-size: 75%;"class="fas fa-question-circle" title="If CodeMirror enabled"></i> &nbsp;<select onchange="selectBrackets()" id=bracketsSelect style="background-color: #282828;color:#a1a1a1;border-color:#a1a1a1;"><option selected>disabled</option><option>enabled</option></select></span><span style="margin-left:5px"><i>(alt+shift+s is quicksave, alt+shift+c is colour picker, F11/ESC for fullscreen on/off)</i></span>
                                    </div>
                                    <label for="responses">Response (<span class="cc-length-counter">
                                    {{- with .CC.Responses}}{{- index . 0|toRune|len -}}</span>/20000)</label>{{else}}x/20000{{- end -}}

                                    <!-- Use .btn-add for simplicity and let the page loader adjust. -->
                                    <div class="entry input-group input-group-sm">
                                        <div class="form-control response-text-area tab-textbox withScrollbar">
                                            <textarea class="pagst-textarea cc-editor form-control response-text-area tab-textbox withScrollbar" name="responses"
                                                    placeholder="Command body here" rows="7" id="pagst-textarea" onfocus="textAreaWrapper(this)" oninput="onCCChanged(this)">{{- with .CC.Responses}}{{- index . 0 -}}{{else}}void{{- end -}}
                                            </textarea>
                                        </div>
                                    </div>                                  
                                    <span style="display: inline-block;vertical-align: middle;"><button type="submit" id="pagstSubmitSave" class="btn btn-sm btn-success btn-block"
                                    formaction="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/update"
                                    data-async-form-alertsonly>Save</button></span>
                                    <a class="mb-1 mt-1 mr-1 modal-basic btn btn-info btn-sm" href="#cc-help-modal">Info</a>
                                    Jump to CC: 
                                    <select id="ccJumper" style="background-color: #282828;color:#a1a1a1;border-color:#1a1a1a;">
                                        {{range .CustomCommands}}
                                            {{$ID := .LocalID}}
                                            {{$trigType := ""}}
                                            {{$trigName := ""}}
                                            {{if eq .GroupID.Int64 $.CC.GroupID.Int64}}
                                                {{if eq .TriggerType 1 2 3 4}}{{$trigName = print " - " (or .RegexTrigger .TextTrigger "void")}}{{end}}
                                                {{if eq .TriggerType 0}}
                                                    {{$trigType = "cmd"}}
                                                    {{$trigName = print "- " (or .TextTrigger "void")}}
                                                {{else if eq .TriggerType 1}}
                                                    {{$trigType = "starts w."}}
                                                {{else if eq .TriggerType 2}}
                                                    {{$trigType = "contains"}}
                                                {{else if eq .TriggerType 3}}
                                                    {{$trigType = "regex"}}
                                                {{else if eq .TriggerType 4}}
                                                    {{$trigType = "ex. match"}}
                                                {{else if eq .TriggerType 5}}
                                                    {{if eq (call $.GetCCIntervalType $.CC) 1}}
                                                        {{$trigType = "hourly interval"}}
                                                    {{else}}
                                                        {{$trigType = "minute interval"}}
                                                    {{end}}
                                                {{else if eq .TriggerType 6}}
                                                    {{$trigType = "reaction"}}
                                                    {{if eq .ReactionTriggerMode 1}}{{$trigType = print $trigType " added"}}
                                                    {{else if eq .ReactionTriggerMode 2}}{{$trigType = print $trigType " removed"}}
                                                    {{else}}{{$trigType = print $trigType " added/removed"}}
                                                    {{end}}
                                                {{else}}{{$trigType = "none"}}
                                                {{end}}
                                                {{if gt (toRune $trigName|len) 64}}{{$trigName = print (slice (toRune $trigName) 0 64|str) "..."}}{{end}}
                                                {{$option := printf "#%d - %s %s" $ID $trigType $trigName}}
                                                {{if eq $.CC.LocalID $ID}}
                                                <option selected value="{{$ID}}">{{$option}}</option>
                                                {{else}}
                                                <option value="{{$ID}}">{{$option}}</option>
                                                {{end}}
                                            {{end}}
                                        {{end}}
                                    </select>
                                    <script>
                                        $(function(){
                                            $('#ccJumper').on('change', function () {
                                                const regex = /\/{{.CC.LocalID}}\//i;
                                                const re = "{{.RequestURI}}";

                                                var newCCID = $(this).val();
                                                var jumper = "{{.BaseURL}}" + re.replace(regex,"/"+newCCID+"/")
                                                
                                                if (jumper) {
                                                    if (confirm("Are you sure you want to jump to CC #"+newCCID+"?\n\n...\n\nMake sure you've saved!")){
                                                        window.location = jumper; // redirect    
                                                    }
                                                    
                                                }
                                                return false;
                                            });
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Notes (<span class="note-length-counter">{{toRune .CC.Note.String|len}}</span>/256)</label>
                                    <input type="text" class="form-control pagst-note" name="note" placeholder="Annotate this custom command..." value="{{if .CC.Note.Valid}}{{.CC.Note.String}}{{end}}" oninput="onNoteChanged(this)">
                                    <p>An optional description on what this command does.</p>
                                </div>

                                <div class="form-group">
                                    <label>Custom command group</label>
                                    {{$selectedGroup := .CC.GroupID.Int64}}
                                    <select Name="GroupID" class="form-control">
                                        <option {{if eq $selectedGroup 0}}selected{{end}} value="0">None
                                        </option>
                                        {{range $dot.CommandGroups}}<option value="{{.ID}}"
                                            {{if eq $selectedGroup .ID}}selected{{end}}>{{.Name}}</option>
                                        {{end}}
                                    </select>
                                </div>

                                <h4>Last error</h4>
                                <p>{{if .CC.LastError}}
                                    <b><span id="PAGST-CC-Last-Error" title="{{formatTime .CC.LastErrorTime.Time.UTC}}">
                                        <script>
                                            var date = new Date({{.CC.LastErrorTime.Time.UTC.Unix}} * 1000);
                                                document.getElementById("PAGST-CC-Last-Error").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(date);
                                        </script>
                                    </span></b> - <code>
                                    {{.CC.LastError}}</code>{{else}}None{{end}}</p>

                                    <div class="row">
                                        <div class="col-auto">
                                            <h4>Run count</h4>
                                            <p><code>{{humanizeThousands .CC.RunCount}}</code></p>
                                        </div>

                                        <div class="col-auto">
                                            <h4>Last run</h4>
                                            <p><code>{{if .CC.LastRun.Valid}}
                                                <span id="PAGST-CC-Last-Run-Footer" title="{{.CC.LastRun.Time.UTC.Format `2006-01-02 15:04:05 MST`}}">
                                                    <script>
                                                        var runDate = new Date({{.CC.LastRun.Time.UTC.Unix}} * 1000);
                                                        document.getElementById("PAGST-CC-Last-Run-Footer").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(runDate);
                                                    </script>
                                                </span>{{else}}None{{end}}</code>
                                            </p>
                                        </div>

                                        {{if eq .CC.TriggerType 5}}
                                        <div class="col-auto">
                                            <h4>Next scheduled run</h4>
                                            <p><code>
                                                <span id="PAGST-CC-Next-Run-Footer" title="{{.CC.NextRun.Time.UTC.Format `2006-01-02 15:04:05 MST`}}">
                                                    <script>
                                                        var date = new Date({{.CC.NextRun.Time.UTC.Unix}} * 1000);
                                                        document.getElementById("PAGST-CC-Next-Run-Footer").innerHTML = new Intl.DateTimeFormat(Intl.DateTimeFormat().resolvedOptions().locale, { dateStyle: 'medium', timeStyle: 'long' }).format(date);
                                                    </script>
                                                </span></code>
                                            </p>
                                        </div>
                                        {{end}}
                                    </div>

                                <h4>Output errors as command response</h4>
                                {{checkbox "show_errors" "show_errors" "" .CC.ShowErrors}}
                            </div>
                            <div id="cc-extra-settings" class="col-sm-6">
                                <h3>User Role/Category/Channel restrictions</h3>
                                <div class="radio">
                                    <label>
                                        <input id="require-role-mode" type="radio" name="require_roles" value="on"
                                            {{if .CC.RolesWhitelistMode}}checked{{end}}>
                                        Require at least one of the roles in the following lists
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input id="ignore-role-mode" type="radio" name="require_roles" value=""
                                            {{if not .CC.RolesWhitelistMode}}checked{{end}}>
                                        Ignore the roles in the following list
                                    </label>
                                </div>
                                <select name="roles" class="multiselect form-control" multiple="multiple"
                                    id="command-roles" data-plugin-multiselect>
                                    {{roleOptionsMulti $g.Roles nil .CC.Roles}}
                                </select>

                                <hr>
                                <div class="row mb-0">
                                    <div class="col mb-0">
                                        <div class="radio">
                                            <label>
                                                <input id="require-category-mode" type="radio" name="require_categories" value="on"
                                                    {{if .CC.CategoriesWhitelistMode}}checked{{end}}>
                                                Only run in the following categories
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input id="ignore-category-mode" type="radio" name="require_categories" value=""
                                                    {{if not .CC.CategoriesWhitelistMode}}checked{{end}}>
                                                Ignore the categories in the following list
                                            </label>
                                        </div>
                                        <select name="categories" class="multiselect form-control" multiple="multiple"
                                            id="command-categories" data-plugin-multiselect>
                                            {{catChannelOptionsMulti $g.Channels .CC.Categories}}
                                        </select>
                                    </div>
                                    <div class="col mb-0">
                                        <div class="radio">
                                            <label>
                                                <input id="require-channel-mode" type="radio" name="require_channels" value="on"
                                                    {{if .CC.ChannelsWhitelistMode}}checked{{end}}>
                                                Only run in the following channels
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input id="ignore-channel-mode" type="radio" name="require_channels" value=""
                                                    {{if not .CC.ChannelsWhitelistMode}}checked{{end}}>
                                                Ignore the channels in the following list
                                            </label>
                                        </div>
                                        <select name="channels" class="multiselect form-control" multiple="multiple"
                                            id="command-channels" data-plugin-multiselect>
                                            {{textChannelOptionsMulti $g.Channels .CC.Channels}}
                                        </select>
                                        <div>
                                            <h4>Threads enabled</h4>
                                            {{checkbox "threads_enabled" "threads_enabled" "" .CC.ThreadsEnabled}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <script type="text/javascript" src="/static/js/shortcuts.js"></script>
                            <script>shortcut.add("shift+alt+s",function(){document.getElementById('pagstSubmitSave').click();});</script>
                            <div class="col">
                                <button type="submit" id="pagstSubmitSave" class="btn btn-success btn-block"
                                    formaction="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/update"
                                    data-async-form-alertsonly>Save</button>
                            </div>
                            <div class="col">
                                <button type="submit" class="btn btn-danger btn-block"
                                    formaction="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/delete">Delete</button>
                            </div>
                        </div>
                        <div class="row mt-4" id="interval-cc-run-now">
                            <div class="col">
                                <button type="submit" class="btn btn-secondary btn-block" title="This will trigger this custom command immediately"
                                    formaction="/manage/{{$guild}}/customcommands/commands/{{.CC.LocalID}}/update_and_run">Run now</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="cc-help-modal" class="modal-block modal-header-color modal-block-info mfp-hide">
    <section class="card">
        <header class="card-header">
            <h2 class="card-title">Custom Command Information</h2>
        </header>
        <div class="card-body">
            <div class="modal-wrapper">
                <div class="modal-text">
                    <p class="help-block">Available template data is {{template "template_helper_user"}} (and much
                        more)
                    </p>
                    <p class="help-block">Execute bot commands using
                        <code>{{`{{exec "command" "arg1" "arg2"}}`}}</code>, Example:
                        <code>{{"{{exec \"role\" \"{{.BotName}}\"}}"}}</code> will be the same as the user typing
                        <code>(mention or prefix) role {{.BotName}}</code></p>
                    <p class="help-block">Arguments are available in a string array: <code>.CmdArgs</code><br>
                        Access
                        single arguments by index using <code>{{"{{index .CmdArgs 0}}"}}</code><br>Get the number of
                        arguments using <code>{{"{{len .CmdArgs}}"}}</code><br>Loop over them with
                        <br><code>{{"{{range .CmdArgs}}{{.}}"}} <- that dot will be replaced by the current argument we're looping over{{"{{end}}"}}</code><br>"end"
                        marks the end of the for loop.</p>
                    <!-- {{/* .IgnoreMe */}} -->
                    <p>
                        See the <a href="https://github.com/mrbentarikau/pagst-rtfm" target="_blank">templating RTFM</a> and <a
                            href="https://docs.yagpdb.xyz/commands/custom-commands" target="_blank">custom
                            command</a>
                        docs for more info.</p>
                </div>
            </div>
        </div>
        <footer class="card-footer">
            <div class="row">
                <div class="col-md-12 text-right">
                    <button class="btn btn-info modal-dismiss">OK</button>
                </div>
            </div>
        </footer>
    </section>
</div>

<script src="/static/vendorr/tln/tln.min.js"></script>
<link rel="stylesheet" href="/static/vendorr/tln/tln.min.css">

<style>
    html.dark .input-group-prepend > .input-group-text {
        background-color: #1f1f1f!important;
    }
</style>

<script src="/static/codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="/static/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="/static/codemirror/addon/colorpicker/codemirror-colorpicker.css">
<link rel="stylesheet" href="/static/codemirror/addon/display/fullscreen.css">
<link rel="stylesheet" href="/static/codemirror/addon/fold/foldgutter.css">

<script src="/static/codemirror/addon/display/fullscreen.js"></script>
<script src="/static/codemirror/addon/colorpicker/codemirror-colorpicker.js"></script>
<script src="/static/codemirror/addon/edit/closebrackets.js"></script>
<script src="/static/codemirror/addon/edit/matchbrackets.js"></script>
<script src="/static/codemirror/addon/fold/foldcode.js"></script>
<script src="/static/codemirror/addon/fold/foldgutter.js"></script>
<script src="/static/codemirror/addon/fold/brace-fold.js"></script>

<script src="/static/codemirror/mode/go/go.js"></script>
<script src="/static/codemirror/mode/go/templateHL.js"></script>

<link rel="stylesheet" href="/static/codemirror/theme/ayu-dark.css">
<link rel="stylesheet" href="/static/codemirror/theme/bespin.css">
<link rel="stylesheet" href="/static/codemirror/theme/cobalt.css">
<link rel="stylesheet" href="/static/codemirror/theme/darcula.css">
<link rel="stylesheet" href="/static/codemirror/theme/gruvbox-dark.css">
<link rel="stylesheet" href="/static/codemirror/theme/mbo.css">
<link rel="stylesheet" href="/static/codemirror/theme/monokai.css">
<link rel="stylesheet" href="/static/codemirror/theme/nord.css">
<link rel="stylesheet" href="/static/codemirror/theme/panda-syntax.css">
<link rel="stylesheet" href="/static/codemirror/theme/vibrant-ink.css">
<link rel="stylesheet" href="/static/codemirror/theme/yonce.css">

<script type="text/javascript">
    function isTextTrigger(t) {
        return t === "cmd";
    }

    function isRegexTrigger(t) {
        return t === "prefix" ||
            t === "contains" ||
            t === "regex" ||
            t === "exact";
    }

    function triggerTypeChanged() {
        const existingCategoriesWarning =$("#require-no-categories-warning");
        const existingChannelsWarning = $("#require-no-channels-warning");
        const existingRolesWarning =$("#require-no-roles-warning");

        if (existingCategoriesWarning.length > 0) {
            existingCategoriesWarning.attr("hidden",false);
        }

        if (existingChannelsWarning.length > 0) {
            existingChannelsWarning.attr("hidden",false);
        }

        if (existingRolesWarning.length > 0) {
            existingRolesWarning.attr("hidden",false);
        }

        var dropdown = $("#trigger-type-dropdown")
        if (dropdown.val() === "interval_hours" || dropdown.val() === "interval_minutes") {
            // Interval triggers

            $("#interval-cc-run-now").removeClass("hidden")
            $("#cc-time-trigger-details").removeClass("hidden");

            $("#cc-text-trigger-details").addClass("hidden");
            $("#cc-regex-trigger-details").addClass("hidden");
            $("#cc-extra-settings").addClass("hidden");

            $("#cc-reaction-trigger-details").addClass("hidden")

            $("#trigger-warning").attr("hidden", true);

            handleTimeTriggerChannelChange();
            $("#time-trigger-no-channel-warning").removeClass("hidden");
            $("#require-no-roles-warning").addClass("hidden");
            $("#time-trigger-no-channel-warning").removeClass("hidden");

        } else if (dropdown.val() === "reaction") {
            // Reaction triggers

            $("#cc-reaction-trigger-details").removeClass("hidden")
            $("#cc-extra-settings").removeClass("hidden");

            $("#cc-time-trigger-details").addClass("hidden");
            $("#cc-text-trigger-details").addClass("hidden");
            $("#cc-regex-trigger-details").addClass("hidden");

            $("#interval-cc-run-now").addClass("hidden")

            $("#trigger-warning").attr("hidden", true);
            $("#time-trigger-no-channel-warning").addClass("hidden");
            $("#require-no-channels-warning").removeClass("hidden");
            $("#require-no-roles-warning").removeClass("hidden");
            $("#time-trigger-no-channel-warning").addClass("hidden");

        } else if (isTextTrigger(dropdown.val())) {
            // Other message triggers

            $("#cc-text-trigger-details").removeClass("hidden");
            $("#cc-extra-settings").removeClass("hidden");

            $("#cc-regex-trigger-details").addClass("hidden");

            $("#cc-reaction-trigger-details").addClass("hidden")
            $("#cc-time-trigger-details").addClass("hidden");

            $("#interval-cc-run-now").addClass("hidden")

            $("#trigger-warning").attr("hidden", true);
            $("#require-no-channels-warning").removeClass("hidden");
            $("#require-no-roles-warning").removeClass("hidden");
            // $("#trigger-warning").text("No trigger set, this command will only be able to be called from other commands")
            $("#time-trigger-no-channel-warning").addClass("hidden");

        } else if (isRegexTrigger(dropdown.val())) {
            // Other message triggers

            $("#cc-regex-trigger-details").removeClass("hidden");
            $("#cc-extra-settings").removeClass("hidden");

            $("#cc-text-trigger-details").addClass("hidden");

            $("#cc-reaction-trigger-details").addClass("hidden")
            $("#cc-time-trigger-details").addClass("hidden");

            $("#interval-cc-run-now").addClass("hidden")

            $("#trigger-warning").attr("hidden", true);
            $("#require-no-channels-warning").removeClass("hidden");
            $("#require-no-roles-warning").removeClass("hidden");
            // $("#trigger-warning").text("No trigger set, this command will only be able to be called from other commands")
            $("#time-trigger-no-channel-warning").addClass("hidden");

        } else {
            // No automatic trigger

            $("#cc-text-trigger-details").addClass("hidden");
            $("#cc-regex-trigger-details").addClass("hidden");
            $("#cc-extra-settings").addClass("hidden");
            $("#cc-reaction-trigger-details").addClass("hidden")
            $("#cc-time-trigger-details").addClass("hidden");

            $("#interval-cc-run-now").addClass("hidden")

            $("#trigger-warning").removeAttr("hidden");
            $("#trigger-warning").text("No trigger set, this command will only be able to be called from other commands")
            $("#time-trigger-no-channel-warning").addClass("hidden");
            $("#require-no-channels-warning").addClass("hidden");
            $("#require-no-roles-warning").addClass("hidden");
            $("#time-trigger-no-channel-warning").addClass("hidden")
        };

        if (dropdown.val() === "cmd") $("#command-trigger-prepended-prefix").show();
        else $("#command-trigger-prepended-prefix").hide();

        $("#trigger-help").children().each(function (i, v) {
            $(v).attr("hidden", true);
        });

        $("#trigger-desc-" + dropdown.val()).removeAttr("hidden");
    }

    $(function () {
        handleTimeTriggerChannelChange();
        handleRestrictionChange($("#require-role-mode").prop("checked"), $("#command-roles"), "require-no-roles-warning", requireNoRolesWarning);
        handleRestrictionChange($("#require-channel-mode").prop("checked"), $("#command-channels"), "require-no-channels-warning", requireNoChannelsWarning);
        handleRestrictionChange($("#require-category-mode").prop("checked"), $("#command-categories"), "require-no-categories-warning", requireNoCategoriesWarning);
        triggerTypeChanged();
    })
    
    var textAreaTheme = getCookie("codeMirror_textAreaTheme");
    if (textAreaTheme == ""){
        textAreaTheme = "no CodeMirror"
    }
    var themeSelectElement = document.getElementById("themeSelect");
    themeSelect.value = textAreaTheme;

    var bracketsEnabled = false;
    var input = document.getElementById("themeSelect");
    var bracketsInput = document.getElementById("bracketsSelect");

    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function selectTheme() {
        textAreaTheme = input.options[input.selectedIndex].textContent;
        if (textAreaTheme == "no CodeMirror") {
            location.hash = "";
        } else {
            location.hash = "#" + textAreaTheme;
        }
        document.cookie = "codeMirror_textAreaTheme=" + textAreaTheme + "; max-age=3153600000; path=/; Secure";
        editorToTextArea();
    }

    function selectBrackets() {
        editorToTextArea();
        if (bracketsInput.options[bracketsInput.selectedIndex].textContent == "enabled") {
            bracketsEnabled = true;
            return
        } 
        bracketsEnabled = false;
    }
    
    function editorToTextArea(){
        if (typeof editor !== 'undefined' && editor){
            editor.toTextArea();
            return
        }
        console.log("no CodeMirror, yet");
        return
    }
    var choice = (location.hash && location.hash.slice(1)) ||
               (document.location.search &&
                decodeURIComponent(document.location.search.slice(1)));
    if (choice) {
        input.value = choice;
        textAreaTheme = choice;
    }

    function textAreaWrapper(textAreaWrapperValue){
        if (textAreaTheme == "no CodeMirror") {
            return
    }

    editor = CodeMirror.fromTextArea(textAreaWrapperValue,{
        mode: "text/x-go",
        //tabSize: 4,
        autoCloseBrackets: bracketsEnabled,
        matchBrackets: true,
        electricChars: false,
        colorpicker : {
           mode: 'edit',
           type: 'box',
        },
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        lineNumbers:true,
        lineWrapping:true,
        showInvisibles:true,
        viewportMargin: 10,
        theme: textAreaTheme,
        extraKeys: {
            "F11": function(cm) {
              cm.setOption("fullScreen", !cm.getOption("fullScreen"));
            },
            "Esc": function(cm) {
              if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
            },
            'Shift-Alt-C' : function (cm, event) {
            cm.state.colorpicker.popup_color_picker();
            },
        },
    });
    editor.setSize("100%",null);
    editor.on("focus",function() {onCCChanged(document.querySelector('.CodeMirror'),editor)});
    editor.on("change",function() {editor.save(),onCCChanged(document.querySelector('.CodeMirror'),editor)});
    // editor.on("blur",function() {editor.save(),editor.toTextArea()});
    }

    function lengthScan(scanThis){
        var combinedLength = 0;

        scanThis.forEach(function (elem) {
            // The data received on the backend contains "\r\n" while it is simply "\n" on the JS side.
            // Adjust for this discrepancy by double-counting newline characters.
            const newlines = elem.value.match(/\n/g);
            if (newlines) combinedLength += newlines.length;
            combinedLength += Array.from(elem.value).length;
        })
        return combinedLength;
    }

    function onCCChanged(textArea) {
        var textAreas = textArea.parentElement.parentElement.parentElement.querySelectorAll('textarea.pagst-textarea');
        var combinedLength = lengthScan(textAreas);
        
        var display = textArea.parentElement.parentElement.parentElement.querySelector(".cc-length-counter");
        display.textContent = combinedLength;

        if (combinedLength > 20000) {
            display.classList.add("text-danger");
        } else {
            display.classList.remove("text-danger");
        }
    }

    function onNoteChanged(input) {
        var inputs = input.parentElement.parentElement.parentElement.querySelectorAll('input.pagst-note');
        var combinedLength = lengthScan(inputs);

        var display = input.parentElement.parentElement.parentElement.querySelector(".note-length-counter");
        display.textContent = combinedLength;

        if (combinedLength > 256) {
            display.classList.add("text-danger");
        } else {
            display.classList.remove("text-danger");
        }
    }

    function onTriggerChanged(input) {
        var inputs = input.parentElement.parentElement.parentElement.querySelectorAll('input.pagst-trigger');
        var combinedLength = lengthScan(inputs);

        var display = input.parentElement.parentElement.parentElement.querySelector(".trigger-length-counter");
        display.textContent = combinedLength;

        if (combinedLength > 256) {
            display.classList.add("text-danger");
        } else {
            display.classList.remove("text-danger");
        }
    }

    var idGen = 0

    $("#time-trigger-channel").change(handleTimeTriggerChannelChange);
    function handleTimeTriggerChannelChange() {
        const triggerType = $("#trigger-type-dropdown").val();
        if (triggerType !== "interval_hours" && triggerType !== "interval_minutes") return;
    
        // if no channel is selected for an interval trigger, the command is
        // effectively disabled as it has nowhere to run
        const isChannelSelected = Boolean($("#time-trigger-channel").val());
        
        const existingWarning = $("#time-trigger-no-channel-warning");

        // to remove other command-type warnings
        const existingCategoriesWarning =$("#require-no-categories-warning");
        const existingChannelsWarning =$("#require-no-channels-warning");
        const existingRolesWarning =$("#require-no-roles-warning");

        if (existingChannelsWarning.length > 0) {
            existingChannelsWarning.attr("hidden",true);
        }

        if (existingCategoriesWarning.length > 0) {
            existingCategoriesWarning.attr("hidden",true);
        }

        if (existingRolesWarning.length > 0) {
            existingRolesWarning.attr("hidden",true);
        }

        if (existingWarning.length > 0 && isChannelSelected) {
            // remove existing warning if a channel is selected
            existingWarning.remove();
        } else if (existingWarning.length === 0 && !isChannelSelected) {
            addAlert("warning", "Selecting no channel for the command to run in effectively disables it, making it never run. If your command does not need to run in any specific channel, select a random one from the list instead.", "time-trigger-no-channel-warning");
        }
    }

    var requireNoRolesWarning = "Requiring no roles effectively disables your command, making it run for no one. If you want no role restrictions, set the mode to 'ignore roles' instead.";
    var requireNoChannelsWarning = "Requiring no channels effectively disables your command. If you want no channel restrictions, set the mode to 'ignore channels' instead.";
    var requireNoCategoriesWarning = "Requiring no categories effectively disables your command. If you want no category restrictions, set the mode to 'ignore categories' instead.";

    $("#require-role-mode").change(function() {
        handleRestrictionChange($(this).prop("checked"), $("#command-roles"), "require-no-roles-warning", requireNoRolesWarning);
    });
    $("#ignore-role-mode").change(function() {
        handleRestrictionChange(!$(this).prop("checked"), $("#command-roles"), "require-no-roles-warning", requireNoRolesWarning);
    });
    $("#command-roles").change(function() {
        handleRestrictionChange($("#require-role-mode").prop("checked"), $(this), "require-no-roles-warning", requireNoRolesWarning);
    });

    $("#require-channel-mode").change(function() {
        handleRestrictionChange($(this).prop("checked"), $("#command-channels"), "require-no-channels-warning", requireNoChannelsWarning);
    });
    $("#ignore-channel-mode").change(function() {
        handleRestrictionChange(!$(this).prop("checked"), $("#command-channels"), "require-no-channels-warning", requireNoChannelsWarning);
    });
    $("#command-channels").change(function() {
        handleRestrictionChange($("#require-channel-mode").prop("checked"), $(this), "require-no-channels-warning", requireNoChannelsWarning); 
    });

    $("#require-category-mode").change(function() {
        handleRestrictionChange($(this).prop("checked"), $("#command-categories"), "require-no-categories-warning", requireNoCategoriesWarning);
    });
    $("#ignore-category-mode").change(function() {
        handleRestrictionChange(!$(this).prop("checked"), $("#command-categories"), "require-no-categories-warning", requireNoCategoriesWarning);
    });
    $("#command-categories").change(function() {
        handleRestrictionChange($("#require-category-mode").prop("checked"), $(this), "require-no-categories-warning", requireNoCategoriesWarning); 
    });

    function handleRestrictionChange(modeIsRequire, selectMenu, warningID, warningText) {
        // requiring no roles/channels results in the command not being able to
        // run anywhere, this is typically a mistake
        const doWarn = modeIsRequire && selectMenu.val().length === 0; 
        
        const existingWarning = $(`#${warningID}`);
        if (existingWarning.length > 0 && !doWarn) {
            // remove existing warning if there's no need for it anymore
            existingWarning.remove();
        } else if (existingWarning.length === 0 && doWarn) {
            // warning does not exist, so add it
            addAlert("warning", warningText, warningID);
        }
    }
</script>


{{template "cp_footer" .}}

{{end}}
